{% extends "base.html" %}

{% block title %}Pokedata Explorer - SiteGiant Pricing{% endblock %}
{% block nav_explorer %}active{% endblock %}
{% block page_title %}Explorer{% endblock %}

{% block content %}
{% if error %}
<div class="alert alert-error animate-in">
    <span class="alert-icon">‚ö†Ô∏è</span>
    <div class="alert-content">
        <div class="alert-title">Error</div>
        {{ error }}
    </div>
</div>
{% endif %}

<!-- Search Bar -->
<div class="search-hero animate-in">
    <div class="search-hero-title">
        <span class="glow-icon">üîç</span>
        Pokedata Explorer
    </div>
    <form action="/explorer/search" method="post" id="searchForm" class="search-form-glass">
        <div class="search-input-wrapper">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
            <input type="text" 
                   id="search_query" 
                   name="search_query" 
                   placeholder="Search products by name..."
                   value="{{ search_query|default('', true) }}"
                   autocomplete="off"
                   required>
            <div class="search-mode-toggle">
                <button type="button" class="mode-btn {% if search_mode|default('name') == 'name' %}active{% endif %}" data-mode="name">Name</button>
                <button type="button" class="mode-btn {% if search_mode|default('name') == 'id' %}active{% endif %}" data-mode="id">ID</button>
            </div>
            <input type="hidden" name="search_mode" id="search_mode" value="{{ search_mode|default('name') }}">
        </div>
        <button type="submit" class="btn btn-primary btn-glow search-btn">
            <span>Search</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
        </button>
    </form>
    {% if api_key_set %}
    <div class="search-status">
        <span class="status-dot pulse-ok"></span>
        <span>API Connected</span>
    </div>
    {% else %}
    <div class="search-status warn">
        <span class="status-dot pulse-warn"></span>
        <span>API Key Required</span>
    </div>
    {% endif %}
</div>

<!-- API Key Notice -->
{% if not api_key_set %}
<div class="api-key-banner animate-in delay-1">
    <div class="api-key-banner-content">
        <span class="api-key-icon">üîë</span>
        <div class="api-key-text">
            <strong>API Key Required</strong>
            <span>Enter your Pokedata API key to enable search</span>
        </div>
    </div>
    <form action="/settings/api-key" method="post" class="api-key-form">
        <input type="password" name="api_key" placeholder="Paste API key..." required>
        <button type="submit" class="btn btn-primary btn-sm">Connect</button>
    </form>
</div>
{% endif %}

<!-- Search Results -->
{% if search_results %}
<div class="results-section animate-in delay-1">
    <div class="results-header">
        <h2 class="results-title">
            <span>üìã</span>
            Results
        </h2>
        <span class="results-count">{{ search_results|length }} found</span>
    </div>
    
    <div class="results-table-wrapper glass-card">
        <table class="results-table-v2">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>ID</th>
                    <th>Language</th>
                    <th>Type</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for result in search_results %}
                <tr class="result-row">
                    <td class="col-name-main">{{ result.name }}</td>
                    <td><code class="id-code">{{ result.product_id }}</code></td>
                    <td><span class="lang-tag">{{ result.language }}</span></td>
                    <td class="col-type">{{ result.asset_type }}</td>
                    <td class="col-actions">
                        <a href="/explorer/pricing/{{ result.product_id }}" class="action-btn primary" title="View Pricing">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </a>
                        {% if result.url %}
                        <a href="{{ result.url }}" target="_blank" class="action-btn" title="Open in Pokedata">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                            </svg>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Pricing Details -->
{% if price_info %}
<div class="pricing-section animate-in delay-1">
    <div class="pricing-header">
        <div class="pricing-title-row">
            <h2 class="pricing-title">
                <span>üíµ</span>
                Pricing Details
            </h2>
            <code class="pricing-id">{{ price_info.product_id }}</code>
        </div>
    </div>
    
    <div class="pricing-grid">
        <!-- Primary Price Card -->
        <div class="price-hero-card glass-card">
            <div class="price-hero-label">Primary Price</div>
            <div class="price-hero-value">${{ "%.2f"|format(price_info.primary_price_usd) }}</div>
            <div class="price-hero-source">
                <span class="status-dot pulse-ok"></span>
                {{ price_info.source }}
            </div>
        </div>
        
        <!-- Component Prices -->
        {% if price_info.raw_prices %}
        <div class="price-sources glass-card">
            <div class="price-sources-header">
                <span>üìä</span>
                Price Sources
            </div>
            <div class="price-sources-grid">
                {% for source, price in price_info.raw_prices.items() %}
                <div class="price-source-item">
                    <span class="price-source-value">${{ "%.2f"|format(price) }}</span>
                    <span class="price-source-name">{{ source }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Price History -->
    {% if price_history %}
    <div class="price-history glass-card">
        <div class="price-history-header">
            <span>üìà</span>
            Price History
        </div>
        <div class="price-history-list">
            {% for entry in price_history %}
            <div class="history-item">
                <span class="history-date">{{ entry.date }}</span>
                <span class="history-price">${{ "%.2f"|format(entry.price_usd) }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Empty State -->
{% if not search_results and not price_info and not error %}
<div class="empty-state animate-in delay-1">
    <div class="empty-state-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
    </div>
    <h3 class="empty-state-title">Search Pokedata Products</h3>
    <p class="empty-state-text">Enter a product name or Pokedata ID to get started</p>
    <div class="empty-state-hints">
        <div class="hint-item">
            <span class="hint-icon">üí°</span>
            <span>Try searching "Charizard" or "Booster Box"</span>
        </div>
        <div class="hint-item">
            <span class="hint-icon">üî¢</span>
            <span>Switch to ID mode for direct price lookup</span>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('search_query');
    const searchModeInput = document.getElementById('search_mode');
    const modeBtns = document.querySelectorAll('.mode-btn');
    
    // Mode toggle
    modeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            modeBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const mode = btn.dataset.mode;
            searchModeInput.value = mode;
            
            if (mode === 'name') {
                searchInput.placeholder = "Search products by name...";
            } else {
                searchInput.placeholder = "Enter Pokedata product ID...";
            }
            searchInput.focus();
        });
    });
    
    // Search form animation
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        if (!searchInput.value.trim()) {
            e.preventDefault();
            searchInput.focus();
            return;
        }
        const btn = this.querySelector('.search-btn');
        btn.innerHTML = '<span class="spinner"></span>';
    });
</script>

<style>
/* ============================================
   EXPLORER PAGE - REDESIGN
   ============================================ */

/* Search Hero */
.search-hero {
    text-align: center;
    margin-bottom: 32px;
}

.search-hero-title {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 24px;
}

.glow-icon {
    font-size: 1.4rem;
    filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
}

/* Search Form Glass */
.search-form-glass {
    display: flex;
    gap: 12px;
    max-width: 700px;
    margin: 0 auto;
}

.search-input-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 16px;
    background: rgba(15, 15, 20, 0.6);
    backdrop-filter: blur(24px);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    transition: all 0.3s ease;
}

.search-input-wrapper:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent), var(--accent-glow);
}

.search-icon {
    color: var(--text-muted);
    flex-shrink: 0;
}

.search-input-wrapper input {
    flex: 1;
    background: none;
    border: none;
    padding: 10px 0;
    font-size: 1rem;
    color: var(--text-primary);
    outline: none;
}

.search-input-wrapper input::placeholder {
    color: var(--text-muted);
}

.search-mode-toggle {
    display: flex;
    gap: 4px;
    padding: 4px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-sm);
}

.mode-btn {
    padding: 6px 12px;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-muted);
    background: none;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.mode-btn:hover {
    color: var(--text-primary);
}

.mode-btn.active {
    background: var(--accent);
    color: white;
}

.search-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 14px 24px;
    white-space: nowrap;
}

.search-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
    font-size: 0.85rem;
    color: var(--status-ok);
}

.search-status.warn {
    color: var(--status-warning);
}

/* API Key Banner */
.api-key-banner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
    padding: 16px 24px;
    margin-bottom: 24px;
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: var(--radius-lg);
}

.api-key-banner-content {
    display: flex;
    align-items: center;
    gap: 16px;
}

.api-key-icon {
    font-size: 1.5rem;
}

.api-key-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
    color: var(--status-warning);
}

.api-key-text span {
    font-size: 0.85rem;
    opacity: 0.9;
}

.api-key-form {
    display: flex;
    gap: 8px;
}

.api-key-form input {
    width: 240px;
    padding: 8px 14px;
    font-size: 0.9rem;
}

/* Results Section */
.results-section {
    margin-bottom: 32px;
}

.results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.results-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.results-count {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    padding: 4px 12px;
    background: rgba(112, 0, 255, 0.15);
    border-radius: var(--radius-full);
    color: var(--accent-light);
}

.results-table-wrapper {
    overflow: hidden;
}

.results-table-v2 {
    width: 100%;
    border-collapse: collapse;
}

.results-table-v2 th {
    padding: 14px 20px;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid var(--border-color);
}

.results-table-v2 td {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    color: var(--text-secondary);
    transition: all 0.2s ease;
}

.result-row {
    transition: background 0.2s ease;
}

.result-row:hover td {
    background: rgba(255, 255, 255, 0.03);
    color: var(--text-primary);
}

.col-name-main {
    font-weight: 500;
    color: var(--text-primary);
    max-width: 300px;
}

.id-code {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    padding: 4px 8px;
    background: rgba(112, 0, 255, 0.1);
    border-radius: 4px;
    color: var(--accent-light);
}

.lang-tag {
    font-size: 0.75rem;
    padding: 3px 8px;
    background: rgba(0, 242, 234, 0.1);
    border: 1px solid rgba(0, 242, 234, 0.2);
    border-radius: 4px;
    color: var(--cyan);
    text-transform: uppercase;
}

.col-type {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.col-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.action-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--text-muted);
    color: var(--text-primary);
}

.action-btn.primary {
    background: rgba(112, 0, 255, 0.15);
    border-color: rgba(112, 0, 255, 0.3);
    color: var(--accent-light);
}

.action-btn.primary:hover {
    background: rgba(112, 0, 255, 0.25);
}

/* Pricing Section */
.pricing-section {
    margin-bottom: 32px;
}

.pricing-header {
    margin-bottom: 20px;
}

.pricing-title-row {
    display: flex;
    align-items: center;
    gap: 16px;
}

.pricing-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.pricing-id {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    padding: 4px 12px;
    background: rgba(16, 185, 129, 0.15);
    border-radius: var(--radius-full);
    color: var(--status-ok);
}

.pricing-grid {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .pricing-grid {
        grid-template-columns: 1fr;
    }
}

/* Price Hero Card */
.price-hero-card {
    padding: 32px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.price-hero-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--cyan), var(--accent));
}

.price-hero-label {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.price-hero-value {
    font-family: var(--font-mono);
    font-size: 3rem;
    font-weight: 700;
    background: linear-gradient(135deg, #fff, var(--cyan));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent;
    margin-bottom: 12px;
}

.price-hero-source {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* Price Sources */
.price-sources {
    padding: 24px;
}

.price-sources-header {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-primary);
}

.price-sources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 16px;
}

.price-source-item {
    display: flex;
    flex-direction: column;
    padding: 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--radius-md);
    text-align: center;
}

.price-source-value {
    font-family: var(--font-mono);
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.price-source-name {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-muted);
}

/* Price History */
.price-history {
    padding: 24px;
}

.price-history-header {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-primary);
}

.price-history-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.history-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--radius-sm);
}

.history-date {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.history-price {
    font-family: var(--font-mono);
    font-weight: 500;
    color: var(--text-primary);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 24px;
}

.empty-state-icon {
    color: var(--text-muted);
    margin-bottom: 24px;
    opacity: 0.5;
}

.empty-state-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.empty-state-text {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin-bottom: 32px;
}

.empty-state-hints {
    display: inline-flex;
    flex-direction: column;
    gap: 12px;
    text-align: left;
}

.hint-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.hint-icon {
    font-size: 1.1rem;
}

/* Responsive */
@media (max-width: 700px) {
    .search-form-glass {
        flex-direction: column;
    }
    
    .search-btn {
        width: 100%;
        justify-content: center;
    }
    
    .api-key-banner {
        flex-direction: column;
        text-align: center;
    }
    
    .api-key-form {
        width: 100%;
        flex-direction: column;
    }
    
    .api-key-form input {
        width: 100%;
    }
}
</style>
{% endblock %}
