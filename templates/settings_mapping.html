{% extends "base.html" %}

{% block title %}Mapping Settings - SiteGiant Pricing{% endblock %}
{% block nav_settings %}active{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
{% if success %}
<div class="alert alert-success animate-in">
    <span class="alert-icon">‚úì</span>
    <div class="alert-content">{{ success }}</div>
</div>
{% endif %}

{% if error %}
<div class="alert alert-error animate-in">
    <span class="alert-icon">‚ö†Ô∏è</span>
    <div class="alert-content">{{ error }}</div>
</div>
{% endif %}

{% if duplicates_found %}
<!-- Duplicate SKUs Warning Panel -->
<div class="duplicate-warning-panel animate-in glass-card">
    <div class="duplicate-header">
        <span class="duplicate-icon">‚ö†Ô∏è</span>
        <h3>Duplicate SKUs Detected</h3>
    </div>
    <div class="duplicate-summary">
        <p>Found <strong>{{ duplicate_count }}</strong> duplicate SKU(s) in your mapping file ({{ total_rows }} total rows).</p>
        <p>Please choose how to handle them:</p>
    </div>
    
    <div class="duplicate-list">
        <details open>
            <summary>View duplicate SKUs ({{ duplicate_count }})</summary>
            <div class="duplicate-table-wrapper">
                <table class="duplicate-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Appears in Rows</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sku in duplicate_skus %}
                        <tr>
                            <td><code>{{ sku }}</code></td>
                            <td>{{ duplicate_details[sku]|join(', ') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </div>
    
    <form action="/settings/mapping/confirm" method="post" class="duplicate-form">
        <input type="hidden" name="temp_file" value="{{ temp_file }}">
        <input type="hidden" name="auto_lookup" value="{{ 'true' if auto_lookup else 'false' }}">
        
        <div class="strategy-options">
            <label class="strategy-option {% if default_strategy == 'merge' %}selected{% endif %}">
                <input type="radio" name="strategy" value="merge" {% if default_strategy == 'merge' %}checked{% endif %}>
                <div class="strategy-content">
                    <span class="strategy-icon">üîÑ</span>
                    <div class="strategy-text">
                        <strong>Merge (Keep Last)</strong>
                        <span>Overwrites earlier entries with later ones</span>
                    </div>
                </div>
            </label>
            <label class="strategy-option {% if default_strategy == 'ignore' %}selected{% endif %}">
                <input type="radio" name="strategy" value="ignore" {% if default_strategy == 'ignore' %}checked{% endif %}>
                <div class="strategy-content">
                    <span class="strategy-icon">‚è≠Ô∏è</span>
                    <div class="strategy-text">
                        <strong>Ignore (Keep First)</strong>
                        <span>Keeps first entry, skips duplicates</span>
                    </div>
                </div>
            </label>
        </div>
        
        <div class="duplicate-actions">
            <a href="/settings/mapping" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Apply & Save</button>
        </div>
    </form>
</div>
{% endif %}

{% if lookup_results %}
<!-- Auto-Lookup Results Panel -->
<div class="lookup-results-panel animate-in glass-card">
    <div class="lookup-results-header">
        <h3>üîç Auto-Lookup Results</h3>
        <div class="lookup-stats">
            <span class="lookup-stat found">‚úì {{ lookup_results.found|length }} found</span>
            <span class="lookup-stat not-found">‚úó {{ lookup_results.not_found|length }} not found</span>
            {% if lookup_results.errors %}<span class="lookup-stat error">‚ö† {{ lookup_results.errors|length }} errors</span>{% endif %}
            {% if lookup_results.skipped %}<span class="lookup-stat skipped">‚Ü∑ {{ lookup_results.skipped }} skipped</span>{% endif %}
        </div>
    </div>
    
    {% if lookup_results.found %}
    <details class="lookup-section found" open>
        <summary>
            <span class="section-icon">‚úì</span>
            <span class="section-title">Successfully Found ({{ lookup_results.found|length }})</span>
            <span class="chevron">‚ñº</span>
        </summary>
        <div class="lookup-table-wrapper">
            <table class="lookup-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Product Name (from URL)</th>
                        <th>Pokedata ID</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in lookup_results.found %}
                    <tr>
                        <td><code>{{ item.sku }}</code></td>
                        <td>{{ item.product_name }}</td>
                        <td><span class="id-badge">{{ item.pokedata_id }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </details>
    {% endif %}
    
    {% if lookup_results.not_found %}
    <details class="lookup-section not-found" {% if not lookup_results.found %}open{% endif %}>
        <summary>
            <span class="section-icon">‚úó</span>
            <span class="section-title">Not Found ({{ lookup_results.not_found|length }})</span>
            <span class="chevron">‚ñº</span>
        </summary>
        <div class="lookup-table-wrapper">
            <table class="lookup-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Product Name (from URL)</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in lookup_results.not_found %}
                    <tr>
                        <td><code>{{ item.sku }}</code></td>
                        <td>{{ item.product_name }}</td>
                        <td class="reason">{{ item.reason }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="lookup-help">
            üí° <strong>Tip:</strong> Products not found may have different names on Pokedata. 
            Check the exact product name on <a href="https://www.pokedata.io/products" target="_blank">pokedata.io</a> 
            and update your mapping file manually.
        </div>
    </details>
    {% endif %}
    
    {% if lookup_results.errors %}
    <details class="lookup-section errors">
        <summary>
            <span class="section-icon">‚ö†</span>
            <span class="section-title">Errors ({{ lookup_results.errors|length }})</span>
            <span class="chevron">‚ñº</span>
        </summary>
        <div class="lookup-table-wrapper">
            <table class="lookup-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Product Name</th>
                        <th>Error</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in lookup_results.errors %}
                    <tr>
                        <td><code>{{ item.sku }}</code></td>
                        <td>{{ item.product_name }}</td>
                        <td class="error-msg">{{ item.error }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </details>
    {% endif %}
</div>
{% endif %}

<!-- Compact Header with Tabs -->
<div class="settings-page animate-in">
    <div class="settings-header-compact">
        <div class="settings-header-left">
            <h1 class="settings-title-compact">
                <span class="glow-icon">‚öôÔ∏è</span>
                Settings
            </h1>
        </div>
        <div class="settings-header-right">
            <div class="header-status-pills">
                <div class="header-pill {% if api_key_set %}ok{% else %}warn{% endif %}">
                    <span class="status-dot {% if api_key_set %}pulse-ok{% else %}pulse-warn{% endif %}"></span>
                    <span>API: {% if api_key_set %}‚úì{% else %}‚úó{% endif %}</span>
                </div>
                <div class="header-pill {% if mapping_info.exists %}ok{% else %}warn{% endif %}">
                    <span class="status-dot {% if mapping_info.exists %}pulse-ok{% else %}pulse-warn{% endif %}"></span>
                    <span>{% if mapping_info.exists %}{{ mapping_info.row_count }}{% else %}0{% endif %} Products</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab Navigation -->
    <div class="settings-tabs">
        <button class="settings-tab active" data-tab="mapping" onclick="switchTab('mapping')">
            <span class="tab-icon">üìã</span>
            <span class="tab-label">Mapping</span>
        </button>
        <button class="settings-tab" data-tab="config" onclick="switchTab('config')">
            <span class="tab-icon">‚ö°</span>
            <span class="tab-label">Config</span>
        </button>
        <button class="settings-tab" data-tab="history" onclick="switchTab('history')">
            <span class="tab-icon">üìä</span>
            <span class="tab-label">History</span>
        </button>
        <button class="settings-tab" data-tab="help" onclick="switchTab('help')">
            <span class="tab-icon">‚ùì</span>
            <span class="tab-label">Help</span>
        </button>
    </div>

    <!-- Tab Content Panels -->
    <div class="tab-content">
        
        <!-- ==================== TAB 1: MAPPING ==================== -->
        <div class="tab-panel active" id="tab-mapping">
            <div class="tab-panel-header">
                <div class="tab-panel-title">
                    <h2>Mapping Manager</h2>
                    <span class="tab-panel-count">{{ mapping_info.row_count if mapping_info.exists else 0 }} products</span>
                </div>
                <div class="tab-panel-actions">
                    <button type="button" class="btn btn-primary btn-sm" onclick="showAddModal()">
                        <span>+</span> Add
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="showUploadModal()">
                        üì§ Upload
                    </button>
                    {% if mapping_info.exists %}
                    <button type="button" class="btn btn-secondary btn-sm" onclick="refreshMapping()" title="Re-run auto-mapping on products missing Pokedata ID" {% if not api_key_set %}disabled{% endif %}>
                        üîÑ Refresh IDs
                    </button>
                    <a href="/settings/mapping/download" class="btn btn-secondary btn-sm">
                        üì• Download
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <div class="mapping-toolbar glass-card">
                <div class="toolbar-search">
                    <input type="text" id="mappingSearch" placeholder="üîç Search by SKU, name, or URL..." onkeyup="filterMappings()">
                </div>
                <div class="toolbar-filters">
                    <select id="filterLanguage" onchange="filterMappings()" class="filter-select">
                        <option value="">All Languages</option>
                        <option value="ENGLISH">English</option>
                        <option value="JAPANESE">Japanese</option>
                    </select>
                    <select id="filterHasId" onchange="filterMappings()" class="filter-select">
                        <option value="">All Status</option>
                        <option value="has_id">Has Pokedata ID</option>
                        <option value="no_id">Missing ID</option>
                    </select>
                </div>
            </div>
            
            <div class="bulk-actions glass-card" id="bulkActions" style="display:none; margin-bottom: 20px; background: rgba(139, 92, 246, 0.1); border-color: var(--accent);">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="selectedCount" style="font-weight: 600; color: var(--accent-light);">0 selected</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="deleteSelected()" class="btn btn-danger btn-sm" style="background: rgba(248, 113, 113, 0.2); border: 1px solid var(--error); color: var(--error);">üóëÔ∏è Delete Selected</button>
                        <button onclick="clearSelection()" class="btn btn-secondary btn-sm">‚úñ Clear</button>
                    </div>
                </div>
            </div>
            
            <div class="mapping-table-container glass-card">
                <div class="mapping-table-wrapper">
                    <table class="mapping-manager-table" id="mappingTable">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                                <th>SiteGiant Name</th>
                                <th>SKU</th>
                                <th>Pokedata Name</th>
                                <th>ID</th>
                                <th>Lang</th>
                                <th>Auto</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mappingTableBody">
                            <tr class="loading-row">
                                <td colspan="7" class="loading-cell">
                                    <span class="spinner"></span> Loading mappings...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mapping-table-footer">
                    <span id="mappingCount">0 mappings</span>
                </div>
            </div>
        </div>
        
        <!-- ==================== TAB 2: CONFIG ==================== -->
        <div class="tab-panel" id="tab-config">
            <div class="config-grid">
                <!-- API Key Card -->
                <div class="config-card glass-card">
                    <div class="config-card-header">
                        <span class="config-card-icon">üîë</span>
                        <span class="config-card-title">API Key</span>
                        <span class="config-badge {% if api_key_set %}ok{% else %}warn{% endif %}">
                            {% if api_key_set %}Connected{% else %}Not Set{% endif %}
                        </span>
                    </div>
                    <form action="/settings/api-key" method="post" id="apiKeyForm" class="config-card-body">
                        <input type="password" id="api_key" name="api_key" 
                               placeholder="{% if api_key_set %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}Enter API key{% endif %}"
                               class="config-input">
                        <div class="config-card-actions">
                            <button type="submit" class="btn btn-primary btn-sm">Save</button>
                            {% if api_key_set %}
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearApiKey()">Clear</button>
                            {% endif %}
                        </div>
                    </form>
                </div>
                
                <!-- Pricing Config Card -->
                <div class="config-card glass-card">
                    <div class="config-card-header">
                        <span class="config-card-icon">üí±</span>
                        <span class="config-card-title">Pricing</span>
                    </div>
                    <form action="/settings/config" method="post" id="configForm" class="config-card-body">
                        <div class="config-row">
                            <div class="config-field">
                                <label>FX Rate (USD‚ÜíMYR)</label>
                                <div class="config-input-group">
                                    <input type="number" id="fx_rate" name="fx_rate" step="0.0001" min="1" max="10" value="{{ settings.fx_rate }}" class="config-input">
                                    <button type="button" id="fxRefreshBtn" class="config-btn" onclick="fetchFxRate()" title="Refresh FX Rate">üîÑ</button>
                                </div>
                            </div>
                            <div class="config-field">
                                <label>Margin Divisor</label>
                                <input type="number" id="margin_divisor" name="margin_divisor" step="0.05" min="0.1" max="1.0" value="{{ settings.margin_divisor }}" class="config-input">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Save Pricing</button>
                    </form>
                </div>
                
                <!-- Thresholds Card -->
                <div class="config-card glass-card">
                    <div class="config-card-header">
                        <span class="config-card-icon">‚ö†Ô∏è</span>
                        <span class="config-card-title">Thresholds</span>
                    </div>
                    <form action="/settings/config" method="post" class="config-card-body">
                        <input type="hidden" name="fx_rate" value="{{ settings.fx_rate }}">
                        <input type="hidden" name="margin_divisor" value="{{ settings.margin_divisor }}">
                        <div class="config-row">
                            <div class="config-field">
                                <label>‚ö†Ô∏è Soft (Warning)</label>
                                <div class="config-input-group">
                                    <input type="number" id="soft_threshold" name="soft_threshold" step="1" min="1" max="100" value="{{ settings.soft_threshold|int }}" class="config-input">
                                    <span class="config-suffix">%</span>
                                </div>
                            </div>
                            <div class="config-field">
                                <label>üö´ Hard (Blocked)</label>
                                <div class="config-input-group">
                                    <input type="number" id="hard_threshold" name="hard_threshold" step="1" min="1" max="100" value="{{ settings.hard_threshold|int }}" class="config-input">
                                    <span class="config-suffix">%</span>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Save Thresholds</button>
                    </form>
                </div>
                
                <!-- File Management Card -->
                <div class="config-card glass-card">
                    <div class="config-card-header">
                        <span class="config-card-icon">üìÅ</span>
                        <span class="config-card-title">Mapping File</span>
                    </div>
                    <div class="config-card-body">
                        {% if mapping_info.exists %}
                        <div class="file-info">
                            <div class="file-info-row">
                                <span class="file-info-label">File:</span>
                                <span class="file-info-value">pokedata_mapping.xlsx</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Size:</span>
                                <span class="file-info-value">{{ mapping_info.file_size }}</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Modified:</span>
                                <span class="file-info-value">{{ mapping_info.last_modified }}</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Products:</span>
                                <span class="file-info-value">{{ mapping_info.row_count }}</span>
                            </div>
                        </div>
                        <div class="config-card-actions">
                            <a href="/settings/mapping/download" class="btn btn-secondary btn-sm">üì• Download</a>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="showUploadModal()">üì§ Replace</button>
                        </div>
                        {% else %}
                        <div class="file-empty">
                            <span>üì≠</span>
                            <p>No mapping file uploaded</p>
                            <button type="button" class="btn btn-primary btn-sm" onclick="showUploadModal()">Upload Mapping</button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== TAB 3: HISTORY ==================== -->
        <div class="tab-panel" id="tab-history">
            <div class="tab-panel-header">
                <div class="tab-panel-title">
                    <h2>Price Export History</h2>
                </div>
                <div class="tab-panel-actions">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="exportHistory()">üì• Export to Excel</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="refreshHistory()">üîÑ Refresh</button>
                </div>
            </div>
            
            <div class="history-filters glass-card">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="historySearch" placeholder="SKU or product..." oninput="filterHistory()">
                </div>
                <div class="filter-group">
                    <label>From</label>
                    <input type="date" id="historyStartDate" onchange="filterHistory()">
                </div>
                <div class="filter-group">
                    <label>To</label>
                    <input type="date" id="historyEndDate" onchange="filterHistory()">
                </div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="clearHistoryFilters()">Clear</button>
            </div>
            
            <div class="history-summary glass-card" id="historyStats">
                <span class="stat-item">Total Exports: <strong>0</strong></span>
                <span class="stat-item">Products: <strong>0</strong></span>
            </div>
            
            <div class="history-table-container glass-card">
                <div class="history-table-wrapper">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>SKU</th>
                                <th>Product</th>
                                <th>Old Price</th>
                                <th>New Price</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr><td colspan="6" class="empty-cell">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="history-footer">
                    <span id="historyCount">0 records</span>
                    <button type="button" class="btn btn-danger btn-sm" onclick="clearAllHistory()">üóëÔ∏è Clear All</button>
                </div>
            </div>
        </div>
        
        <!-- ==================== TAB 4: HELP ==================== -->
        <div class="tab-panel" id="tab-help">
            <div class="help-grid">
                <!-- Getting Started -->
                <div class="help-card glass-card">
                    <div class="help-card-header">
                        <span class="help-card-icon">üöÄ</span>
                        <span class="help-card-title">Getting Started</span>
                    </div>
                    <div class="help-card-body">
                        <div class="help-steps">
                            <div class="help-step">
                                <span class="help-step-number">1</span>
                                <div class="help-step-content">
                                    <strong>Export from SiteGiant</strong>
                                    <p>Go to Products ‚Üí Export ‚Üí Excel</p>
                                </div>
                            </div>
                            <div class="help-step">
                                <span class="help-step-number">2</span>
                                <div class="help-step-content">
                                    <strong>Generate Template</strong>
                                    <p>Upload your SiteGiant export to create a mapping template</p>
                                </div>
                            </div>
                            <div class="help-step">
                                <span class="help-step-number">3</span>
                                <div class="help-step-content">
                                    <strong>Add Pokedata URLs</strong>
                                    <p>Find products on pokedata.io and paste URLs in the template</p>
                                </div>
                            </div>
                            <div class="help-step">
                                <span class="help-step-number">4</span>
                                <div class="help-step-content">
                                    <strong>Upload Template</strong>
                                    <p>Upload your filled template ‚Äî IDs are looked up automatically</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Template -->
                <div class="help-card glass-card">
                    <div class="help-card-header">
                        <span class="help-card-icon">‚ú®</span>
                        <span class="help-card-title">Generate Template</span>
                    </div>
                    <div class="help-card-body">
                        <p>Create a mapping template from your SiteGiant product export.</p>
                        <form action="/settings/mapping/generate-template" method="post" enctype="multipart/form-data" id="generateForm">
                            <div class="upload-zone-compact" id="dropzone-generate">
                                <input type="file" id="sitegiant_export" name="sitegiant_export" accept=".xlsx,.xls,.csv" required>
                                <div class="upload-zone-content">
                                    <span>üìÑ Drop SiteGiant export here</span>
                                    <span class="upload-filename" id="generate-filename"></span>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block" id="generateBtn">Generate Template</button>
                        </form>
                    </div>
                </div>
                
                <!-- Required Columns -->
                <div class="help-card glass-card">
                    <div class="help-card-header">
                        <span class="help-card-icon">üìù</span>
                        <span class="help-card-title">Required Columns</span>
                    </div>
                    <div class="help-card-body">
                        <div class="columns-list">
                            <div class="column-group">
                                <span class="column-group-title">Required</span>
                                <code>sku</code> - Your product identifier
                                <code>pokedata_id</code> - Numeric ID from Pokedata
                                <code>pokedata_language</code> - ENGLISH or JAPANESE
                                <code>auto_update</code> - Y or N
                            </div>
                            <div class="column-group">
                                <span class="column-group-title">Optional (for Auto-lookup)</span>
                                <code>pokedata_url</code> - URL from pokedata.io
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tips -->
                <div class="help-card glass-card">
                    <div class="help-card-header">
                        <span class="help-card-icon">üí°</span>
                        <span class="help-card-title">Tips</span>
                    </div>
                    <div class="help-card-body">
                        <ul class="tips-list">
                            <li>Pokedata IDs are <strong>automatically looked up</strong> from URLs when API key is set</li>
                            <li>Set <strong>auto_update = N</strong> for products you want to exclude from price updates</li>
                            <li>The <strong>FX Rate</strong> auto-refreshes from Google Finance when you click üîÑ</li>
                            <li>Products above the <strong>Hard Threshold</strong> won't be included in exports</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
    </div><!-- End tab-content -->
</div><!-- End settings-page -->

<!-- Upload Mapping Modal -->
<div class="modal-overlay" id="uploadModal">
    <div class="modal glass-card">
        <div class="modal-header">
            <h3>üì§ Upload Mapping File</h3>
            <button type="button" class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <form action="/settings/mapping/upload" method="post" enctype="multipart/form-data" id="uploadForm">
            <div class="modal-body">
                <div class="upload-zone" id="dropzone">
                    <input type="file" id="mapping_file" name="mapping_file" accept=".xlsx,.xls,.csv" required>
                    <div class="upload-zone-visual">
                        <div class="upload-zone-icon">üìÑ</div>
                        <div class="upload-zone-text">Drop file here or click to browse</div>
                        <div class="upload-zone-subtext">.xlsx, .xls, .csv supported</div>
                    </div>
                    <div class="upload-zone-selected" id="fileSelected">
                        <span class="file-icon">üìÑ</span>
                        <span class="file-name" id="fileName"></span>
                        <button type="button" class="file-remove" id="fileRemove">‚úï</button>
                    </div>
                </div>
                <!-- Auto-lookup is always enabled when API key is set -->
                <input type="hidden" name="auto_lookup" value="{% if api_key_set %}true{% else %}false{% endif %}">
                {% if api_key_set %}
                <div class="upload-info" style="padding: 8px 12px; background: rgba(0, 242, 234, 0.1); border-radius: 8px; font-size: 0.85rem; color: var(--accent-light);">
                    üîç Auto-lookup enabled ‚Äî Missing Pokedata IDs will be searched automatically
                </div>
                {% else %}
                <div class="upload-warning" style="padding: 8px 12px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; font-size: 0.85rem; color: var(--status-warning);">
                    ‚ö†Ô∏è Auto-lookup disabled ‚Äî Set API key in Config tab to enable automatic ID lookup
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Upload Mapping</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="mappingModal">
    <div class="modal glass-card">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Mapping</h3>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="mappingForm" onsubmit="saveMappingForm(event)">
            <input type="hidden" id="formMode" value="add">
            <input type="hidden" id="originalSku" value="">
            
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="formSku">SKU * <span class="field-hint">(Required - must be unique)</span></label>
                        <input type="text" id="formSku" name="sku" required placeholder="e.g. ABC-001" 
                               pattern="[A-Za-z0-9\-_\.\*\s]+" title="SKU can contain letters, numbers, dashes, underscores, dots, asterisks"
                               oninput="validateSkuField(this)">
                        <div class="field-error" id="skuError"></div>
                    </div>
                    <div class="form-group">
                        <label for="formName">Product Name <span class="field-hint">(Your SiteGiant name)</span></label>
                        <input type="text" id="formName" name="name" placeholder="Your product name">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="formUrl">Pokedata URL <span class="field-hint">(Paste URL then click üîç to auto-fill ID)</span></label>
                    <div class="input-with-action">
                        <input type="url" id="formUrl" name="pokedata_url" placeholder="https://www.pokedata.io/product/..."
                               oninput="validateUrlField(this)">
                        <button type="button" class="btn btn-sm btn-lookup" onclick="lookupFromUrl()" title="Lookup ID from URL">
                            üîç
                        </button>
                    </div>
                    <div class="field-error" id="urlError"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="formId">Pokedata ID <span class="field-hint">(Numeric ID from Pokedata)</span></label>
                        <input type="text" id="formId" name="pokedata_id" placeholder="Auto-filled or manual"
                               oninput="validateIdField(this)">
                        <div class="field-error" id="idError"></div>
                    </div>
                    <div class="form-group">
                        <label for="formPokeName">Pokedata Name <span class="field-hint">(Name on Pokedata site)</span></label>
                        <input type="text" id="formPokeName" name="pokedata_name" placeholder="Name on Pokedata">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="formLanguage">Language</label>
                        <select id="formLanguage" name="pokedata_language">
                            <option value="ENGLISH">ENGLISH</option>
                            <option value="JAPANESE">JAPANESE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="formAssetType">Asset Type</label>
                        <select id="formAssetType" name="pokedata_asset_type">
                            <option value="PRODUCT">PRODUCT</option>
                            <option value="CARD">CARD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="formAutoUpdate">Auto Update</label>
                        <select id="formAutoUpdate" name="auto_update">
                            <option value="Y">Yes</option>
                            <option value="N">No</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="formNotes">Notes</label>
                    <input type="text" id="formNotes" name="notes" placeholder="Optional notes">
                </div>
                
                <div id="lookupStatus" class="lookup-status"></div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveBtn">Save Mapping</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // ============================================
    // TAB SWITCHING
    // ============================================
    
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.tab === tabName) {
                tab.classList.add('active');
            }
        });
        
        // Update tab panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById('tab-' + tabName).classList.add('active');
        
        // Load data for specific tabs
        if (tabName === 'mapping') {
            refreshMappings();
        } else if (tabName === 'history') {
            refreshHistory();
        }
        
        // Save active tab to localStorage
        localStorage.setItem('settingsActiveTab', tabName);
    }
    
    // Restore active tab on page load
    document.addEventListener('DOMContentLoaded', () => {
        const savedTab = localStorage.getItem('settingsActiveTab');
        if (savedTab && document.getElementById('tab-' + savedTab)) {
            switchTab(savedTab);
        } else {
            refreshMappings();
        }
    });
    
    // ============================================
    // UPLOAD MODAL
    // ============================================
    
    function showUploadModal() {
        document.getElementById('uploadModal').classList.add('show');
    }
    
    function closeUploadModal() {
        document.getElementById('uploadModal').classList.remove('show');
    }
    
    // Refresh mapping - re-run auto-mapping on existing file
    function refreshMapping() {
        const apiKeySet = {% if api_key_set %}true{% else %}false{% endif %};
        
        if (!apiKeySet) {
            Toast.error('API Key Required', 'Please set your Pokedata API key in the Config tab first.');
            return;
        }
        
        Confirm.show(
            'üîÑ Refresh Mapping IDs?',
            'This will search Pokedata for all products missing a Pokedata ID and try to match them by product name. Products that already have an ID will be skipped.',
            () => {
                Loading.show('Refreshing Mapping', 'Searching Pokedata for missing IDs... This may take a moment.');
                
                // Submit as form POST
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/settings/mapping/refresh';
                document.body.appendChild(form);
                form.submit();
            },
            { confirmText: 'Refresh IDs' }
        );
    }
    
    // Close upload modal on click outside
    document.getElementById('uploadModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'uploadModal') closeUploadModal();
    });

    // Clear API key with confirmation
    function clearApiKey() {
        Confirm.show(
            'üóëÔ∏è Clear API Key?',
            'This will remove the saved Pokedata API key. You will need to enter it again to fetch prices.',
            () => {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/settings/api-key/clear';
                document.body.appendChild(form);
                form.submit();
            },
            { confirmText: 'Clear Key' }
        );
    }
    
    // Fetch live FX rate
    async function fetchFxRate() {
        const btn = document.getElementById('fxRefreshBtn');
        btn.classList.add('spinning');
        btn.disabled = true;
        
        try {
            const response = await fetch('/fetch-fx-rate');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('fx_rate').value = data.rate.toFixed(4);
                Toast.success('FX Rate Updated', `${data.rate.toFixed(4)} from ${data.source}`);
            } else {
                Toast.error('Failed', data.error || 'Could not fetch rate');
            }
        } catch (e) {
            Toast.error('Error', 'Failed to fetch FX rate');
        } finally {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    // File handling
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('mapping_file');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileRemove = document.getElementById('fileRemove');
    
    const dropzoneGenerate = document.getElementById('dropzone-generate');
    const generateInput = document.getElementById('sitegiant_export');
    const generateFilename = document.getElementById('generate-filename');

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Main dropzone
    dropzone.addEventListener('click', (e) => {
        if (e.target !== fileRemove && !fileRemove.contains(e.target)) {
            fileInput.click();
        }
    });
    
    function showSelectedFile(file) {
        const validTypes = ['.xlsx', '.xls', '.csv'];
        const ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
        
        if (!validTypes.includes(ext)) {
            Toast.error('Invalid File', 'Please upload an Excel or CSV file');
            fileInput.value = '';
            return;
        }
        
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        dropzone.classList.add('has-file');
        Toast.success('File Selected', file.name);
    }
    
    fileInput.addEventListener('change', function(e) {
        if (e.target.files[0]) {
            showSelectedFile(e.target.files[0]);
        } else {
            dropzone.classList.remove('has-file');
        }
    });
    
    fileRemove.addEventListener('click', (e) => {
        e.stopPropagation();
        fileInput.value = '';
        dropzone.classList.remove('has-file');
    });
    
    // Generate dropzone
    dropzoneGenerate.addEventListener('click', () => generateInput.click());
    
    generateInput.addEventListener('change', function(e) {
        if (e.target.files[0]) {
            const file = e.target.files[0];
            const validTypes = ['.xlsx', '.xls', '.csv'];
            const ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
            
            if (!validTypes.includes(ext)) {
                Toast.error('Invalid File', 'Please upload an Excel or CSV file');
                generateInput.value = '';
                return;
            }
            
            generateFilename.textContent = file.name;
            dropzoneGenerate.classList.add('has-file');
            Toast.success('Export Selected', file.name);
        } else {
            generateFilename.textContent = '';
            dropzoneGenerate.classList.remove('has-file');
        }
    });
    
    // Drag and drop
    function setupDragDrop(zone, input, onFile) {
        ['dragenter', 'dragover'].forEach(event => {
            zone.addEventListener(event, (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(event => {
            zone.addEventListener(event, (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
            });
        });
        
        zone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length) {
                input.files = files;
                input.dispatchEvent(new Event('change'));
            }
        });
    }
    
    setupDragDrop(dropzone, fileInput);
    setupDragDrop(dropzoneGenerate, generateInput);

    // Generate form submit
    document.getElementById('generateForm').addEventListener('submit', function(e) {
        if (!generateInput.files[0]) {
            e.preventDefault();
            Toast.error('No File', 'Please select a SiteGiant export file');
            return;
        }
        
        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Generating...';
    });

    // Upload form submit with confirmation
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const mappingExists = {% if mapping_info.exists %}true{% else %}false{% endif %};
        const apiKeySet = {% if api_key_set %}true{% else %}false{% endif %};
        
        if (!fileInput.files[0]) {
            e.preventDefault();
            Toast.error('No File', 'Please select a mapping file');
            return;
        }
        
        // Auto-lookup is always enabled when API key is set
        const loadingTitle = apiKeySet ? 'Processing Mapping' : 'Uploading Mapping';
        const loadingMsg = apiKeySet 
            ? 'Looking up Pokedata IDs... This may take a moment.' 
            : 'Validating columns...';
        
        if (mappingExists) {
            e.preventDefault();
            Confirm.show(
                '‚ö†Ô∏è Replace Mapping?',
                apiKeySet 
                    ? 'This will overwrite the existing mapping file and lookup Pokedata IDs automatically.'
                    : 'This will overwrite the existing mapping file.',
                () => {
                    Loading.show(loadingTitle, loadingMsg);
                    document.getElementById('uploadForm').submit();
                },
                { confirmText: 'Replace' }
            );
            return;
        }
        
        Loading.show(loadingTitle, loadingMsg);
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> ' + (apiKeySet ? 'Processing...' : 'Uploading...');
    });
    
    // ============================================
    // MAPPING MANAGER FUNCTIONS
    // ============================================
    
    let allMappings = [];
    
    // Load mappings on page load
    document.addEventListener('DOMContentLoaded', () => {
        refreshMappings();
    });
    
    async function refreshMappings() {
        const tbody = document.getElementById('mappingTableBody');
        tbody.innerHTML = '<tr class="loading-row"><td colspan="7" class="loading-cell"><span class="spinner"></span> Loading mappings...</td></tr>';
        
        try {
            const response = await fetch('/api/mapping');
            const data = await response.json();
            allMappings = data.mappings || [];
            renderMappings(allMappings);
            document.getElementById('mappingCount').textContent = `${allMappings.length} mappings`;
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="7" class="error-cell">Failed to load mappings</td></tr>';
            console.error('Failed to load mappings:', e);
        }
    }
    
    function renderMappings(mappings) {
        const tbody = document.getElementById('mappingTableBody');
        
        if (mappings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">No mappings yet. Click "Add New Mapping" to create one.</td></tr>';
            return;
        }
        
        tbody.innerHTML = mappings.map(m => `
            <tr data-sku="${escapeHtml(m.sku)}">
                <td style="text-align: center;"><input type="checkbox" class="row-select" data-sku="${escapeHtml(m.sku)}" onclick="updateSelectionCount()"></td>
                <td class="name-cell" title="${escapeHtml(m.name || '')}">${escapeHtml(m.name || '-')}</td>
                <td><code>${escapeHtml(m.sku)}</code></td>
                <td class="pokename-cell">
                    ${m.pokedata_url 
                        ? `<a href="${escapeHtml(m.pokedata_url)}" target="_blank" class="pokename-link" title="${escapeHtml(m.pokedata_name || 'Open in Pokedata')}">${escapeHtml(m.pokedata_name || extractNameFromUrl(m.pokedata_url) || '-')}</a>`
                        : `<span title="${escapeHtml(m.pokedata_name || '')}">${escapeHtml(m.pokedata_name || '-')}</span>`
                    }
                </td>
                <td>${m.pokedata_id ? `<span class="id-badge">${escapeHtml(m.pokedata_id)}</span>` : '<span class="no-id">‚Äî</span>'}</td>
                <td><span class="lang-badge ${(m.pokedata_language || 'english').toLowerCase()}">${escapeHtml(m.pokedata_language || 'EN')}</span></td>
                <td><span class="auto-badge ${m.auto_update === 'Y' ? 'yes' : 'no'}">${m.auto_update === 'Y' ? '‚úì' : '‚úó'}</span></td>
                <td class="actions-cell">
                    <button type="button" class="btn-icon edit" onclick="editMapping('${escapeHtml(m.sku)}')" title="Edit">‚úèÔ∏è</button>
                    <button type="button" class="btn-icon delete" onclick="deleteMapping('${escapeHtml(m.sku)}')" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
    }
    
    // Bulk Action Functions
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateSelectionCount();
    }
    
    function updateSelectionCount() {
        const selected = document.querySelectorAll('.row-select:checked');
        const count = selected.length;
        
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        const selectAll = document.getElementById('selectAll');
        
        // Update count text
        selectedCount.textContent = `${count} selected`;
        
        // Show/hide toolbar
        if (count > 0) {
            bulkActions.style.display = 'block';
        } else {
            bulkActions.style.display = 'none';
        }
        
        // Update Select All checkbox state
        const total = document.querySelectorAll('.row-select').length;
        if (total > 0) {
            selectAll.checked = count === total;
            selectAll.indeterminate = count > 0 && count < total;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        }
    }
    
    function clearSelection() {
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(cb => cb.checked = false);
        document.getElementById('selectAll').checked = false;
        updateSelectionCount();
    }
    
    function getSelectedSkus() {
        const selected = document.querySelectorAll('.row-select:checked');
        return Array.from(selected).map(cb => cb.getAttribute('data-sku'));
    }
    
    async function deleteSelected() {
        const skus = getSelectedSkus();
        if (skus.length === 0) return;
        
        Confirm.show(
            'üóëÔ∏è Delete Selected?',
            `Are you sure you want to delete ${skus.length} mappings? This cannot be undone.`,
            async () => {
                try {
                    const response = await fetch('/api/mapping/delete-bulk', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(skus)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        Toast.success('Deleted', data.message);
                        clearSelection();
                        refreshMappings();
                    } else {
                        Toast.error('Error', data.detail || 'Failed to delete mappings');
                    }
                } catch (e) {
                    Toast.error('Error', 'Failed to delete mappings');
                    console.error(e);
                }
            }
        );
    }
    
    function filterMappings() {
        const search = document.getElementById('mappingSearch').value.toLowerCase();
        const filtered = allMappings.filter(m => 
            (m.sku || '').toLowerCase().includes(search) ||
            (m.name || '').toLowerCase().includes(search) ||
            (m.pokedata_name || '').toLowerCase().includes(search) ||
            (m.pokedata_url || '').toLowerCase().includes(search) ||
            (m.pokedata_id || '').toLowerCase().includes(search)
        );
        renderMappings(filtered);
        document.getElementById('mappingCount').textContent = `${filtered.length} of ${allMappings.length} mappings`;
    }
    
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function truncateUrl(url) {
        if (!url) return '';
        const match = url.match(/\/product\/(.+)/);
        return match ? match[1].replace(/\+/g, ' ').substring(0, 30) + (match[1].length > 30 ? '...' : '') : url.substring(0, 30);
    }
    
    function extractNameFromUrl(url) {
        if (!url) return '';
        const match = url.match(/\/product\/(.+)/);
        if (match) {
            return decodeURIComponent(match[1].replace(/\+/g, ' '));
        }
        return '';
    }
    
    // Modal functions
    function showAddModal() {
        document.getElementById('formMode').value = 'add';
        document.getElementById('originalSku').value = '';
        document.getElementById('modalTitle').textContent = 'Add New Mapping';
        document.getElementById('mappingForm').reset();
        document.getElementById('formSku').disabled = false;
        document.getElementById('lookupStatus').innerHTML = '';
        document.getElementById('mappingModal').classList.add('show');
    }
    
    function editMapping(sku) {
        const mapping = allMappings.find(m => m.sku === sku);
        if (!mapping) return;
        
        document.getElementById('formMode').value = 'edit';
        document.getElementById('originalSku').value = sku;
        document.getElementById('modalTitle').textContent = 'Edit Mapping';
        document.getElementById('formSku').value = mapping.sku;
        document.getElementById('formSku').disabled = true;
        document.getElementById('formName').value = mapping.name || '';
        document.getElementById('formUrl').value = mapping.pokedata_url || '';
        document.getElementById('formId').value = mapping.pokedata_id || '';
        document.getElementById('formPokeName').value = mapping.pokedata_name || '';
        document.getElementById('formLanguage').value = mapping.pokedata_language || 'ENGLISH';
        document.getElementById('formAssetType').value = mapping.pokedata_asset_type || 'PRODUCT';
        document.getElementById('formAutoUpdate').value = mapping.auto_update || 'Y';
        document.getElementById('formNotes').value = mapping.notes || '';
        document.getElementById('lookupStatus').innerHTML = '';
        document.getElementById('mappingModal').classList.add('show');
    }
    
    function closeModal() {
        document.getElementById('mappingModal').classList.remove('show');
    }
    
    async function saveMappingForm(e) {
        e.preventDefault();
        
        // Validate form first
        if (!validateForm()) {
            Toast.error('Validation Error', 'Please fix the highlighted errors');
            return;
        }
        
        const mode = document.getElementById('formMode').value;
        const sku = mode === 'edit' ? document.getElementById('originalSku').value : document.getElementById('formSku').value;
        
        const formData = new FormData(document.getElementById('mappingForm'));
        if (mode === 'edit') {
            formData.set('sku', sku);
        }
        
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner"></span> Saving...';
        
        try {
            const url = mode === 'add' ? '/api/mapping/add' : `/api/mapping/${encodeURIComponent(sku)}`;
            const method = mode === 'add' ? 'POST' : 'PUT';
            
            const response = await fetch(url, { method, body: formData });
            const data = await response.json();
            
            if (response.ok) {
                Toast.success('Saved', data.message);
                closeModal();
                refreshMappings();
            } else {
                Toast.error('Error', data.detail || 'Failed to save');
            }
        } catch (e) {
            Toast.error('Error', 'Failed to save mapping');
            console.error(e);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Mapping';
        }
    }
    
    async function deleteMapping(sku) {
        Confirm.show(
            'üóëÔ∏è Delete Mapping?',
            `Are you sure you want to delete the mapping for SKU: ${sku}?`,
            async () => {
                try {
                    const response = await fetch(`/api/mapping/${encodeURIComponent(sku)}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        Toast.success('Deleted', data.message);
                        refreshMappings();
                    } else {
                        Toast.error('Error', data.detail || 'Failed to delete');
                    }
                } catch (e) {
                    Toast.error('Error', 'Failed to delete mapping');
                }
            },
            { confirmText: 'Delete' }
        );
    }
    
    async function lookupFromUrl() {
        const url = document.getElementById('formUrl').value;
        const language = document.getElementById('formLanguage').value;
        const statusDiv = document.getElementById('lookupStatus');
        
        if (!url) {
            Toast.error('No URL', 'Please enter a Pokedata URL first');
            return;
        }
        
        statusDiv.innerHTML = '<span class="spinner"></span> Looking up...';
        statusDiv.className = 'lookup-status loading';
        
        try {
            const formData = new FormData();
            formData.append('pokedata_url', url);
            formData.append('pokedata_language', language);
            
            const response = await fetch('/api/mapping/lookup', { method: 'POST', body: formData });
            const data = await response.json();
            
            if (data.found) {
                document.getElementById('formId').value = data.pokedata_id;
                document.getElementById('formPokeName').value = data.matched_name || data.product_name;
                statusDiv.innerHTML = `‚úì Found: <strong>${data.pokedata_id}</strong> - ${data.matched_name || data.product_name}`;
                statusDiv.className = 'lookup-status success';
                Toast.success('Found', `ID: ${data.pokedata_id}`);
            } else {
                statusDiv.innerHTML = `‚úó Not found: ${data.error || 'No matching product'}`;
                statusDiv.className = 'lookup-status error';
                Toast.error('Not Found', data.error || 'No matching product in Pokedata');
            }
        } catch (e) {
            statusDiv.innerHTML = '‚úó Lookup failed';
            statusDiv.className = 'lookup-status error';
            Toast.error('Error', 'Failed to lookup');
        }
    }
    
    // Close modal on escape key or clicking outside
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
    document.getElementById('mappingModal').addEventListener('click', (e) => {
        if (e.target.id === 'mappingModal') closeModal();
    });
    
    // ============================================
    // FORM VALIDATION FUNCTIONS
    // ============================================
    
    function validateSkuField(input) {
        const errorDiv = document.getElementById('skuError');
        const value = input.value.trim();
        
        if (!value) {
            errorDiv.textContent = 'SKU is required';
            input.classList.add('invalid');
            return false;
        }
        
        // Check if SKU already exists (only in add mode)
        const mode = document.getElementById('formMode').value;
        if (mode === 'add' && allMappings.some(m => m.sku === value)) {
            errorDiv.textContent = 'This SKU already exists';
            input.classList.add('invalid');
            return false;
        }
        
        errorDiv.textContent = '';
        input.classList.remove('invalid');
        return true;
    }
    
    function validateUrlField(input) {
        const errorDiv = document.getElementById('urlError');
        const value = input.value.trim();
        
        if (!value) {
            errorDiv.textContent = '';
            input.classList.remove('invalid');
            return true; // URL is optional
        }
        
        // Check if it's a valid Pokedata URL
        if (!value.includes('pokedata.io/product/')) {
            errorDiv.textContent = 'URL should be from pokedata.io/product/...';
            input.classList.add('invalid');
            return false;
        }
        
        errorDiv.textContent = '';
        input.classList.remove('invalid');
        return true;
    }
    
    function validateIdField(input) {
        const errorDiv = document.getElementById('idError');
        const value = input.value.trim();
        
        if (!value) {
            errorDiv.textContent = '';
            input.classList.remove('invalid');
            return true; // ID is optional (can use auto-lookup)
        }
        
        // Check if it's numeric
        if (!/^\d+$/.test(value)) {
            errorDiv.textContent = 'Pokedata ID should be a number';
            input.classList.add('invalid');
            return false;
        }
        
        errorDiv.textContent = '';
        input.classList.remove('invalid');
        return true;
    }
    
    function validateForm() {
        let valid = true;
        
        if (!validateSkuField(document.getElementById('formSku'))) valid = false;
        if (!validateUrlField(document.getElementById('formUrl'))) valid = false;
        if (!validateIdField(document.getElementById('formId'))) valid = false;
        
        return valid;
    }
    
    // ============================================
    // PRICE HISTORY FUNCTIONS
    // ============================================
    
    let historyData = [];
    
    // Load history on page load
    document.addEventListener('DOMContentLoaded', () => {
        refreshHistory();
    });
    
    async function refreshHistory() {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '<tr class="loading-row"><td colspan="6" class="loading-cell"><span class="spinner"></span> Loading history...</td></tr>';
        
        try {
            const params = new URLSearchParams();
            const search = document.getElementById('historySearch').value;
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            
            if (search) params.append('sku', search);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            
            const response = await fetch(`/api/history?${params}`);
            const data = await response.json();
            
            historyData = data.records || [];
            renderHistory(historyData);
            updateHistoryStats(data.stats);
            document.getElementById('historyCount').textContent = `${historyData.length} records`;
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="6" class="error-cell">Failed to load history</td></tr>';
            console.error('Failed to load history:', e);
        }
    }
    
    function renderHistory(records) {
        const tbody = document.getElementById('historyTableBody');
        
        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No export history yet. Exports will be logged here.</td></tr>';
            return;
        }
        
        tbody.innerHTML = records.map(r => {
            const changeClass = r.change_percent > 0 ? 'positive' : (r.change_percent < 0 ? 'negative' : 'neutral');
            const changeSign = r.change_percent > 0 ? '+' : '';
            
            return `
                <tr>
                    <td class="date-cell">
                        <span class="date">${r.export_date || ''}</span>
                        <span class="time">${r.export_time || ''}</span>
                    </td>
                    <td><code>${escapeHtml(r.sku)}</code></td>
                    <td class="product-cell" title="${escapeHtml(r.product_name)}">${escapeHtml(r.product_name || '-')}</td>
                    <td class="price-cell">RM ${parseFloat(r.old_price || 0).toFixed(2)}</td>
                    <td class="price-cell">RM ${parseFloat(r.new_price || 0).toFixed(2)}</td>
                    <td class="change-cell ${changeClass}">
                        <span class="change-amount">${changeSign}RM ${parseFloat(r.change_amount || 0).toFixed(2)}</span>
                        <span class="change-percent">(${changeSign}${parseFloat(r.change_percent || 0).toFixed(1)}%)</span>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function updateHistoryStats(stats) {
        const statsEl = document.getElementById('historyStats');
        if (stats) {
            statsEl.innerHTML = `
                <span class="stat-item">Total Exports: <strong>${stats.total_exports || 0}</strong></span>
                <span class="stat-item">Products: <strong>${stats.unique_products || 0}</strong></span>
                ${stats.last_export ? `<span class="stat-item">Last: <strong>${stats.last_export}</strong></span>` : ''}
            `;
        }
    }
    
    function filterHistory() {
        // Debounce the filter
        clearTimeout(window.historyFilterTimeout);
        window.historyFilterTimeout = setTimeout(() => {
            refreshHistory();
        }, 300);
    }
    
    function clearHistoryFilters() {
        document.getElementById('historySearch').value = '';
        document.getElementById('historyStartDate').value = '';
        document.getElementById('historyEndDate').value = '';
        refreshHistory();
    }
    
    async function exportHistory() {
        const params = new URLSearchParams();
        const search = document.getElementById('historySearch').value;
        const startDate = document.getElementById('historyStartDate').value;
        const endDate = document.getElementById('historyEndDate').value;
        
        if (search) params.append('sku', search);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        
        window.location.href = `/api/history/export?${params}`;
    }
    
    async function clearAllHistory() {
        Confirm.show(
            'üóëÔ∏è Clear All History?',
            'This will permanently delete all price export history. This cannot be undone.',
            async () => {
                try {
                    const response = await fetch('/api/history/clear', { method: 'POST' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        Toast.success('Cleared', data.message);
                        refreshHistory();
                    } else {
                        Toast.error('Error', data.detail || 'Failed to clear history');
                    }
                } catch (e) {
                    Toast.error('Error', 'Failed to clear history');
                }
            },
            { confirmText: 'Clear All' }
        );
    }
</script>

<style>
/* ============================================
   SETTINGS PAGE - TABBED REDESIGN
   ============================================ */

/* Settings Page Container */
.settings-page {
    display: flex;
    flex-direction: column;
    gap: 0;
}

/* Compact Header */
.settings-header-compact {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 0;
}

.settings-title-compact {
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
}

/* Tab Navigation */
.settings-tabs {
    display: flex;
    gap: 4px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0, 0, 0, 0.2);
    margin: 0 -24px;
    padding-left: 24px;
    padding-right: 24px;
}

.settings-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: transparent;
    border: none;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    position: relative;
}

.settings-tab:hover {
    color: var(--text-primary);
    background: rgba(112, 0, 255, 0.05);
}

.settings-tab.active {
    color: var(--accent);
    background: rgba(112, 0, 255, 0.1);
}

.settings-tab.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--accent);
}

.tab-icon {
    font-size: 1.1rem;
}

.tab-label {
    font-weight: 500;
}

/* Tab Content */
.tab-content {
    padding-top: 20px;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Tab Panel Header */
.tab-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
}

.tab-panel-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.tab-panel-title h2 {
    margin: 0;
    font-size: 1.25rem;
}

.tab-panel-count {
    font-size: 0.85rem;
    color: var(--text-muted);
    background: rgba(112, 0, 255, 0.1);
    padding: 4px 10px;
    border-radius: 12px;
}

.tab-panel-actions {
    display: flex;
    gap: 8px;
}

/* Mapping Toolbar */
.mapping-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 16px;
    gap: 16px;
    flex-wrap: wrap;
}

.toolbar-search {
    flex: 1;
    min-width: 200px;
}

.toolbar-search input {
    width: 100%;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
}

.toolbar-filters {
    display: flex;
    gap: 8px;
}

.filter-select {
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    cursor: pointer;
}

/* Config Grid */
.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.config-card {
    padding: 20px;
}

.config-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}

.config-card-icon {
    font-size: 1.25rem;
}

.config-card-title {
    flex: 1;
    font-weight: 600;
    font-size: 1rem;
}

.config-badge {
    font-size: 0.75rem;
    padding: 4px 8px;
    border-radius: 4px;
}

.config-badge.ok {
    background: rgba(52, 211, 153, 0.15);
    color: var(--status-ok);
}

.config-badge.warn {
    background: rgba(251, 191, 36, 0.15);
    color: var(--status-warn);
}

.config-card-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.config-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.config-field label {
    display: block;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 6px;
}

.config-input {
    width: 100%;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
}

.config-input-group {
    display: flex;
    gap: 8px;
}

.config-input-group .config-input {
    flex: 1;
}

.config-btn {
    padding: 8px 12px;
    background: rgba(112, 0, 255, 0.1);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    cursor: pointer;
}

.config-btn:hover {
    background: rgba(112, 0, 255, 0.2);
}

.config-suffix {
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
}

.config-card-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

/* File Info */
.file-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.file-info-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
}

.file-info-label {
    color: var(--text-muted);
}

.file-info-value {
    color: var(--text-primary);
}

.file-empty {
    text-align: center;
    padding: 20px;
    color: var(--text-muted);
}

.file-empty span {
    font-size: 2rem;
    display: block;
    margin-bottom: 8px;
}

/* History Summary */
.history-summary {
    display: flex;
    gap: 24px;
    padding: 12px 16px;
    margin-bottom: 16px;
}

.history-summary .stat-item {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.history-summary .stat-item strong {
    color: var(--text-primary);
}

/* Help Grid */
.help-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.help-card {
    padding: 20px;
}

.help-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}

.help-card-icon {
    font-size: 1.25rem;
}

.help-card-title {
    font-weight: 600;
    font-size: 1rem;
}

.help-card-body {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.help-card-body p {
    margin: 0 0 12px 0;
}

/* Help Steps */
.help-steps {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.help-step {
    display: flex;
    gap: 12px;
}

.help-step-number {
    width: 28px;
    height: 28px;
    background: rgba(112, 0, 255, 0.15);
    color: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.85rem;
    flex-shrink: 0;
}

.help-step-content strong {
    display: block;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.help-step-content p {
    margin: 0;
    font-size: 0.85rem;
}

/* Columns List */
.columns-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.column-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.column-group-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-muted);
    font-weight: 600;
}

.column-group code {
    font-size: 0.8rem;
    padding: 4px 8px;
    background: rgba(112, 0, 255, 0.1);
    border-radius: 4px;
    display: inline-block;
    margin-bottom: 2px;
}

/* Tips List */
.tips-list {
    margin: 0;
    padding-left: 20px;
}

.tips-list li {
    margin-bottom: 8px;
}

/* Upload Zone Compact */
.upload-zone-compact {
    position: relative;
    padding: 16px;
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    text-align: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.2s ease;
}

.upload-zone-compact:hover {
    border-color: var(--accent);
    background: rgba(112, 0, 255, 0.05);
}

.upload-zone-compact input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
}

.upload-zone-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    color: var(--text-muted);
}

.upload-filename {
    font-size: 0.85rem;
    color: var(--accent);
}

/* Upload Options */
.upload-options {
    margin-top: 16px;
}

.upload-warning {
    font-size: 0.8rem;
    color: var(--status-warn);
    margin-top: 8px;
}

/* Settings Header (legacy support) */
.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.settings-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.settings-subtitle {
    color: var(--text-secondary);
    font-size: 0.95rem;
}

.header-status-pills {
    display: flex;
    gap: 12px;
}

.header-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-full);
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.header-pill.ok {
    border-color: rgba(16, 185, 129, 0.3);
    color: var(--status-ok);
}

.header-pill.warn {
    border-color: rgba(245, 158, 11, 0.3);
    color: var(--status-warning);
}

/* Workflow Stepper */
.workflow-stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    margin-bottom: 32px;
    padding: 20px;
    background: rgba(15, 15, 20, 0.4);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.step {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    border-radius: var(--radius-md);
    transition: all 0.3s ease;
}

.step.active {
    background: rgba(112, 0, 255, 0.15);
    border: 1px solid rgba(112, 0, 255, 0.3);
}

.step.completed {
    opacity: 0.7;
}

.step.completed .step-number {
    background: var(--status-ok);
}

.step-number {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    border-radius: 50%;
    font-weight: 600;
    font-size: 0.9rem;
    color: white;
}

.step-content {
    text-align: left;
}

.step-title {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-primary);
}

.step-title a {
    color: inherit;
}

.step-desc {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.step-connector {
    width: 40px;
    height: 2px;
    background: var(--border-color);
}

.step-connector.completed {
    background: var(--status-ok);
}

/* Settings Grid */
.settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    align-items: start;
}

@media (max-width: 900px) {
    .settings-grid {
        grid-template-columns: 1fr;
    }
    
    .workflow-stepper {
        flex-direction: column;
        gap: 8px;
    }
    
    .step-connector {
        width: 2px;
        height: 20px;
    }
}

.settings-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Settings Card */
.settings-card {
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.settings-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
}

.settings-card-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: var(--text-primary);
}

.settings-card-body {
    padding: 20px;
}

.primary-card {
    position: relative;
}

.primary-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), var(--cyan), transparent);
}

/* Collapsible */
.collapsible summary {
    cursor: pointer;
    list-style: none;
}

.collapsible summary::-webkit-details-marker {
    display: none;
}

.collapsible .chevron {
    transition: transform 0.2s ease;
    color: var(--text-muted);
}

.collapsible[open] .chevron {
    transform: rotate(180deg);
}

.collapsible .settings-card-body {
    border-top: 1px solid var(--border-color);
}

/* Download Button */
.download-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    transition: all 0.2s ease;
}

.download-btn:hover {
    background: rgba(112, 0, 255, 0.2);
    border-color: var(--accent);
    color: var(--accent-light);
}

/* Mapping Stats */
.mapping-stats {
    display: flex;
    gap: 16px;
    padding: 16px 20px;
    flex-wrap: wrap;
}

.mapping-stat {
    display: flex;
    flex-direction: column;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--radius-md);
    min-width: 80px;
}

.mapping-stat-value {
    font-family: var(--font-mono);
    font-weight: 600;
    color: var(--text-primary);
}

.mapping-stat-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-top: 2px;
}

.mapping-columns {
    padding: 12px 20px;
    border-top: 1px solid var(--border-color);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.mapping-columns code {
    font-size: 0.75rem;
    padding: 2px 8px;
    background: rgba(112, 0, 255, 0.1);
    border-radius: 4px;
    color: var(--accent-light);
}

.mapping-empty {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 24px 20px;
    color: var(--text-muted);
}

.mapping-empty-icon {
    font-size: 1.5rem;
}

/* Upload Zone Mini */
.upload-zone-mini {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.upload-zone-mini input[type="file"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.upload-zone-mini-content {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-muted);
}

.upload-zone-mini-text {
    font-size: 0.9rem;
}

.upload-zone-mini-filename {
    font-weight: 500;
    color: var(--cyan);
    display: none;
}

.upload-zone-mini.has-file .upload-zone-mini-text {
    display: none;
}

.upload-zone-mini.has-file .upload-zone-mini-filename {
    display: block;
}

.upload-zone-mini:hover,
.upload-zone-mini.drag-over {
    border-color: var(--accent);
    background: rgba(112, 0, 255, 0.05);
}

.upload-zone-mini.has-file {
    border-color: var(--cyan);
    border-style: solid;
}

/* Help Steps */
.help-steps {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-color);
}

.help-step {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.help-step span:first-child {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    font-size: 0.7rem;
    font-weight: 600;
}

/* API Key Form */
.api-key-form-inline {
    display: flex;
    gap: 8px;
}

.api-key-form-inline input {
    flex: 1;
}

/* Config Tiles */
.config-tiles {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
}

.config-tile {
    padding: 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--radius-md);
}

.config-tile-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.config-tile-icon {
    font-size: 1rem;
}

.config-tile-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.config-tile input {
    width: 100%;
    padding: 8px 12px;
    font-size: 0.95rem;
}

.config-tile-input {
    display: flex;
    gap: 8px;
}

.config-tile-input input {
    flex: 1;
}

.config-tile-suffix {
    display: flex;
    align-items: center;
    padding: 0 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    color: var(--text-muted);
}

.config-tile-hint {
    display: block;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 6px;
}

/* Refresh Button */
.refresh-btn {
    width: 36px;
    height: 36px;
    padding: 0;
    border: none;
    background: rgba(255, 255, 255, 0.06);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.refresh-btn:hover {
    background: rgba(112, 0, 255, 0.2);
    color: var(--accent-light);
}

.refresh-btn.spinning svg {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Help List */
.help-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.help-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.help-num {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(112, 0, 255, 0.15);
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--accent-light);
}

.help-tip {
    margin-top: 16px;
    padding: 12px;
    background: rgba(0, 242, 234, 0.08);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    color: var(--cyan);
}

/* ============================================
   BENTO GRID LAYOUT
   ============================================ */

.bento-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

.bento-item {
    padding: 20px;
    border-radius: var(--radius-lg);
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.bento-wide {
    grid-column: span 2;
}

.bento-tall {
    grid-row: span 2;
}

.bento-primary {
    position: relative;
}

.bento-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--cyan));
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

/* Bento Header */
.bento-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.bento-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-primary);
}

.bento-icon {
    font-size: 1.2rem;
}

.bento-action {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    transition: all 0.2s ease;
}

.bento-action:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
}

.bento-badge {
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: var(--radius-full);
    font-weight: 500;
    text-transform: uppercase;
}

.bento-badge.ok {
    background: rgba(52, 211, 153, 0.15);
    color: var(--status-ok);
}

.bento-badge.warn {
    background: rgba(251, 191, 36, 0.15);
    color: var(--status-warning);
}

.bento-badge.error {
    background: rgba(248, 113, 113, 0.15);
    color: var(--status-error);
}

/* Bento Stats */
.bento-stats-row {
    display: flex;
    gap: 24px;
}

.bento-stat {
    display: flex;
    flex-direction: column;
}

.bento-stat-value {
    font-family: var(--font-mono);
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-primary);
}

.bento-stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
}

.bento-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.bento-tags code {
    font-size: 0.7rem;
    padding: 3px 8px;
    background: rgba(124, 58, 237, 0.1);
    border-radius: 4px;
    color: var(--accent-light);
}

.bento-empty {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: rgba(245, 158, 11, 0.08);
    border-radius: var(--radius-md);
    color: var(--status-warning);
    font-size: 0.9rem;
}

/* Bento Forms */
.bento-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
}

.bento-form-actions {
    display: flex;
    gap: 8px;
}

.bento-upload {
    display: flex;
    flex-direction: column;
    gap: 16px;
    flex: 1;
}

/* Bento Config Grid */
.bento-config-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 16px;
}

.bento-config-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.bento-config-item label {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.bento-input-group {
    display: flex;
    gap: 6px;
}

.bento-input-group input {
    flex: 1;
}

.input-suffix {
    display: flex;
    align-items: center;
    padding: 0 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* Bento Help */
.bento-help-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.bento-help-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.bento-help-item span:first-child {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    border-radius: 50%;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
}

/* Bento Columns */
.bento-columns {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.bento-col-group {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
}

.bento-col-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-right: 8px;
}

.bento-columns code {
    font-size: 0.7rem;
    padding: 3px 8px;
    background: rgba(124, 58, 237, 0.1);
    border-radius: 4px;
    color: var(--accent-light);
}

/* Button Block */
.btn-block {
    width: 100%;
}

/* Responsive */
@media (max-width: 900px) {
    .bento-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .bento-wide {
        grid-column: span 2;
    }
    
    .bento-tall {
        grid-row: span 1;
    }
    
    .bento-config-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 600px) {
    .bento-grid {
        grid-template-columns: 1fr;
    }
    
    .bento-wide {
        grid-column: span 1;
    }
    
    .bento-config-grid {
        grid-template-columns: 1fr;
    }
}

/* Auto-lookup Checkbox Option */
.auto-lookup-option {
    padding: 12px 14px;
    background: rgba(0, 242, 234, 0.05);
    border: 1px solid rgba(0, 242, 234, 0.2);
    border-radius: var(--radius-md);
    margin-bottom: 12px;
}

.checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    user-select: none;
}

.checkbox-label input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.checkbox-custom {
    width: 20px;
    height: 20px;
    min-width: 20px;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    margin-top: 2px;
}

.checkbox-label input:checked + .checkbox-custom {
    background: var(--cyan);
    border-color: var(--cyan);
}

.checkbox-label input:checked + .checkbox-custom::after {
    content: '‚úì';
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.checkbox-label input:disabled + .checkbox-custom {
    opacity: 0.5;
    cursor: not-allowed;
}

.checkbox-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.checkbox-hint {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.auto-lookup-warning {
    font-size: 0.75rem;
    color: var(--status-warning);
    margin-top: 8px;
    padding-left: 32px;
}

.checkbox-label:has(input:disabled) {
    cursor: not-allowed;
    opacity: 0.7;
}

/* ============================================
   LOOKUP RESULTS PANEL
   ============================================ */

.lookup-results-panel {
    padding: 20px;
    margin-bottom: 24px;
    border-radius: var(--radius-lg);
}

.lookup-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
}

.lookup-results-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text-primary);
}

.lookup-stats {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.lookup-stat {
    font-size: 0.85rem;
    padding: 4px 12px;
    border-radius: var(--radius-full);
    font-weight: 500;
}

.lookup-stat.found {
    background: rgba(52, 211, 153, 0.15);
    color: var(--status-ok);
}

.lookup-stat.not-found {
    background: rgba(251, 191, 36, 0.15);
    color: var(--status-warning);
}

.lookup-stat.error {
    background: rgba(248, 113, 113, 0.15);
    color: var(--status-error);
}

.lookup-stat.skipped {
    background: rgba(148, 163, 184, 0.15);
    color: var(--text-muted);
}

.lookup-section {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    margin-bottom: 12px;
    overflow: hidden;
}

.lookup-section summary {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: pointer;
    background: rgba(0, 0, 0, 0.2);
    list-style: none;
    user-select: none;
}

.lookup-section summary::-webkit-details-marker {
    display: none;
}

.lookup-section.found summary {
    border-left: 3px solid var(--status-ok);
}

.lookup-section.not-found summary {
    border-left: 3px solid var(--status-warning);
}

.lookup-section.errors summary {
    border-left: 3px solid var(--status-error);
}

.lookup-section .section-icon {
    font-size: 1rem;
}

.lookup-section.found .section-icon { color: var(--status-ok); }
.lookup-section.not-found .section-icon { color: var(--status-warning); }
.lookup-section.errors .section-icon { color: var(--status-error); }

.lookup-section .section-title {
    flex: 1;
    font-weight: 500;
    color: var(--text-primary);
}

.lookup-section .chevron {
    color: var(--text-muted);
    transition: transform 0.2s ease;
    font-size: 0.8rem;
}

.lookup-section[open] .chevron {
    transform: rotate(180deg);
}

.lookup-table-wrapper {
    max-height: 300px;
    overflow-y: auto;
}

.lookup-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.lookup-table th,
.lookup-table td {
    padding: 10px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.lookup-table th {
    background: rgba(0, 0, 0, 0.3);
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 0.75rem;
    position: sticky;
    top: 0;
}

.lookup-table td code {
    font-size: 0.8rem;
    padding: 2px 6px;
    background: rgba(112, 0, 255, 0.1);
    border-radius: 4px;
    color: var(--accent-light);
}

.lookup-table .id-badge {
    display: inline-block;
    padding: 3px 10px;
    background: rgba(52, 211, 153, 0.15);
    color: var(--status-ok);
    border-radius: var(--radius-full);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    font-weight: 500;
}

.lookup-table .reason {
    color: var(--status-warning);
    font-size: 0.8rem;
}

.lookup-table .error-msg {
    color: var(--status-error);
    font-size: 0.8rem;
}

.lookup-help {
    padding: 12px 16px;
    background: rgba(0, 242, 234, 0.05);
    border-top: 1px solid var(--border-color);
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.lookup-help a {
    color: var(--cyan);
}

.lookup-help a:hover {
    text-decoration: underline;
}

/* ============================================
   MAPPING MANAGER SECTION
   ============================================ */

.mapping-manager-section {
    margin-top: 32px;
}

.mapping-manager-section .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
}

.mapping-manager-section .section-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
}

.mapping-manager-section .section-actions {
    display: flex;
    gap: 8px;
}

.mapping-table-container {
    padding: 0;
    overflow: hidden;
}

.mapping-search {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
}

.mapping-search input {
    width: 100%;
    padding: 10px 16px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9rem;
}

.mapping-search input:focus {
    outline: none;
    border-color: var(--accent);
}

.mapping-table-wrapper {
    max-height: 500px;
    overflow-y: auto;
}

.mapping-manager-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.mapping-manager-table th,
.mapping-manager-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.mapping-manager-table th {
    background: rgba(0, 0, 0, 0.4);
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 0.75rem;
    position: sticky;
    top: 0;
    z-index: 1;
}

.mapping-manager-table tbody tr:hover {
    background: rgba(112, 0, 255, 0.05);
}

.mapping-manager-table td code {
    font-size: 0.8rem;
    padding: 2px 8px;
    background: rgba(112, 0, 255, 0.1);
    border-radius: 4px;
    color: var(--accent-light);
}

.mapping-manager-table .name-cell,
.mapping-manager-table .pokename-cell {
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.mapping-manager-table .url-link {
    display: inline-block;
    margin-left: 6px;
    color: var(--cyan);
    text-decoration: none;
    font-size: 0.9rem;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.mapping-manager-table .url-link:hover {
    opacity: 1;
    text-decoration: none;
}

.mapping-manager-table .pokename-link {
    color: var(--cyan);
    text-decoration: none;
    transition: all 0.2s;
}

.mapping-manager-table .pokename-link:hover {
    color: #5eead4;
    text-decoration: underline;
}

.mapping-manager-table .id-badge {
    display: inline-block;
    padding: 2px 8px;
    background: rgba(52, 211, 153, 0.15);
    color: var(--status-ok);
    border-radius: var(--radius-full);
    font-family: var(--font-mono);
    font-size: 0.8rem;
}

.mapping-manager-table .no-id {
    color: var(--text-muted);
}

.mapping-manager-table .lang-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
}

.mapping-manager-table .lang-badge.english {
    background: rgba(59, 130, 246, 0.15);
    color: #60a5fa;
}

.mapping-manager-table .lang-badge.japanese {
    background: rgba(248, 113, 113, 0.15);
    color: #f87171;
}

.mapping-manager-table .auto-badge {
    font-size: 0.9rem;
}

.mapping-manager-table .auto-badge.yes {
    color: var(--status-ok);
}

.mapping-manager-table .auto-badge.no {
    color: var(--text-muted);
}

.mapping-manager-table .actions-cell {
    white-space: nowrap;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
    font-size: 1rem;
}

.btn-icon:hover {
    background: rgba(255, 255, 255, 0.1);
}

.btn-icon.delete:hover {
    background: rgba(248, 113, 113, 0.2);
}

.mapping-table-footer {
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
    color: var(--text-muted);
    font-size: 0.85rem;
}

.loading-cell,
.empty-cell,
.error-cell {
    text-align: center;
    padding: 40px 16px !important;
    color: var(--text-muted);
}

.error-cell {
    color: var(--status-error);
}

/* ============================================
   MODAL STYLES
   ============================================ */

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal {
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: var(--radius-lg);
    transform: translateY(-20px);
    transition: transform 0.3s ease;
}

.modal-overlay.show .modal {
    transform: translateY(0);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text-primary);
}

.modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 14px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9rem;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--accent);
}

.form-group input:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.input-with-action {
    display: flex;
    gap: 8px;
}

.input-with-action input {
    flex: 1;
}

.btn-lookup {
    padding: 10px 14px;
    font-size: 1rem;
}

.lookup-status {
    padding: 12px;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    margin-top: 8px;
}

.lookup-status.loading {
    background: rgba(112, 0, 255, 0.1);
    color: var(--accent-light);
}

.lookup-status.success {
    background: rgba(52, 211, 153, 0.1);
    color: var(--status-ok);
}

.lookup-status.error {
    background: rgba(248, 113, 113, 0.1);
    color: var(--status-error);
}

/* ============================================
   PRICE HISTORY SECTION
   ============================================ */

.price-history-section {
    margin-top: 32px;
}

.price-history-section .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
}

.price-history-section .section-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
}

.history-container {
    padding: 0;
    overflow: hidden;
}

.history-filters {
    display: flex;
    gap: 16px;
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    align-items: flex-end;
}

.history-filters .filter-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.history-filters .filter-group label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
}

.history-filters .filter-group input {
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 0.85rem;
}

.history-filters .filter-group input:focus {
    outline: none;
    border-color: var(--accent);
}

.history-stats {
    display: flex;
    gap: 20px;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid var(--border-color);
}

.history-stats .stat-item {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.history-stats .stat-item strong {
    color: var(--text-primary);
}

.history-table-wrapper {
    max-height: 400px;
    overflow-y: auto;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.history-table th,
.history-table td {
    padding: 10px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.history-table th {
    background: rgba(0, 0, 0, 0.4);
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 0.75rem;
    position: sticky;
    top: 0;
    z-index: 1;
}

.history-table tbody tr:hover {
    background: rgba(112, 0, 255, 0.05);
}

.history-table .date-cell {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.history-table .date-cell .date {
    color: var(--text-primary);
}

.history-table .date-cell .time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.history-table td code {
    font-size: 0.8rem;
    padding: 2px 6px;
    background: rgba(112, 0, 255, 0.1);
    border-radius: 4px;
    color: var(--accent-light);
}

.history-table .product-cell {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.history-table .price-cell {
    font-family: var(--font-mono);
    white-space: nowrap;
}

.history-table .change-cell {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.history-table .change-cell.positive {
    color: var(--status-ok);
}

.history-table .change-cell.negative {
    color: var(--status-error);
}

.history-table .change-cell.neutral {
    color: var(--text-muted);
}

.history-table .change-amount {
    font-family: var(--font-mono);
    font-weight: 500;
}

.history-table .change-percent {
    font-size: 0.75rem;
    opacity: 0.8;
}

.history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
    color: var(--text-muted);
    font-size: 0.85rem;
}

.btn-danger {
    background: rgba(248, 113, 113, 0.15);
    border-color: rgba(248, 113, 113, 0.3);
    color: var(--status-error);
}

.btn-danger:hover {
    background: rgba(248, 113, 113, 0.25);
    border-color: var(--status-error);
}

/* ============================================
   FORM VALIDATION STYLES
   ============================================ */

.field-hint {
    font-size: 0.7rem;
    font-weight: 400;
    color: var(--text-muted);
    margin-left: 4px;
}

.field-error {
    font-size: 0.75rem;
    color: var(--status-error);
    margin-top: 4px;
    min-height: 18px;
}

.form-group input.invalid,
.form-group select.invalid {
    border-color: var(--status-error) !important;
    background: rgba(248, 113, 113, 0.05);
}

.form-group input.valid {
    border-color: var(--status-ok) !important;
}

/* Validation tooltip */
.form-group input:focus:invalid {
    box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.2);
}

.form-group input:focus:valid {
    box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.2);
}
</style>
{% endblock %}
